<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>席替えアプリ - 修正版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState, useRef } = React;

      // ---------- Constants & Utils ----------
      const STORAGE_KEY = "sekigae_app_v1";
      const DEFAULT_OPTIONS = {
        trials: 80, hillSteps: 120, historyWindow: 6, visionWeight: 3,
        heightWeight: 1, sameSeatPenalty: 7, sameNeighborPenalty: 6, clusterPenalty: 2,
        preferMixedGender: true, genderMixWeight: 3,
      };

      function uid() { return Math.random().toString(16).slice(2) + Date.now().toString(16); }
      function seatKey(r, c) { return `${r}-${c}`; }
      function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

      function normalizeGender(raw) {
        const s = (raw || "").toString().trim().toLowerCase();
        if (!s) return "unknown";
        if (["f", "female", "woman", "girl", "女", "女性", "女子"].includes(s)) return "female";
        if (["m", "male", "man", "boy", "男", "男性", "男子"].includes(s)) return "male";
        return "unknown";
      }

      function normalizeStudent(st) {
        return {
          id: st?.id ?? uid(),
          name: st?.name ?? "",
          gender: normalizeGender(st?.gender ?? st?.sex),
          vision: st?.vision === "poor" ? "poor" : "normal",
          height: st?.height === "tall" ? "tall" : "normal",
          notes: st?.notes ?? "",
        };
      }

      function adjacencyPairsFromGrid(grid) {
        const pairs = new Set();
        const h = grid.length;
        const w = grid[0]?.length || 0;
        const addPair = (a, b) => {
          if (!a || !b) return;
          pairs.add(a < b ? `${a}|${b}` : `${b}|${a}`);
        };
        for (let r = 0; r < h; r++) {
          for (let c = 0; c < w; c++) {
            if (c + 1 < w) addPair(grid[r][c], grid[r][c + 1]);
            if (r + 1 < h) addPair(grid[r][c], grid[r + 1][c]);
          }
        }
        return pairs;
      }

      // --- Size Cleanup Logic ---
      function pruneFixedMapForSize(fixedMap, rows, cols) {
        const next = {};
        for (const [k, v] of Object.entries(fixedMap || {})) {
          const [r, c] = k.split("-").map(Number);
          if (r >= 0 && r < rows && c >= 0 && c < cols) next[k] = v;
        }
        return next;
      }

      function pruneBlockedForSize(blockedSet, rows, cols) {
        const next = new Set();
        for (const k of blockedSet || []) {
          const [r, c] = (k || "").split("-").map(Number);
          if (r >= 0 && r < rows && c >= 0 && c < cols) next.add(k);
        }
        return next;
      }

      // ---------- UI Components ----------
      function Input({ value, onChange, type = "text", min, max, step }) {
        // スマホ入力対策：空の状態を許容し、数値化は確定時に行う
        const handleChange = (e) => {
          const val = e.target.value;
          if (type === "number") {
            if (val === "") {
              onChange(""); // 一時的に空を許可
            } else {
              const num = Number(val);
              onChange(num);
            }
          } else {
            onChange(val);
          }
        };

        return (
          <input
            className="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm"
            value={value}
            type={type}
            min={min}
            max={max}
            step={step}
            inputMode={type === "number" ? "numeric" : undefined} // スマホで数字キーボードを出す
            onChange={handleChange}
          />
        );
      }

      function Button({ children, onClick, variant = "primary", disabled }) {
        const base = "px-3 py-2 rounded-xl text-sm font-medium transition active:scale-[0.98] disabled:opacity-50";
        const styles = variant === "primary" ? "bg-gray-900 text-white" : "bg-gray-100 text-gray-900";
        return <button className={`${base} ${styles}`} onClick={onClick} disabled={disabled}>{children}</button>;
      }

      function Section({ title, children }) {
        return (
          <div className="bg-white border border-gray-200 rounded-2xl p-4 mb-4 shadow-sm">
            <h3 className="text-base font-semibold mb-3">{title}</h3>
            {children}
          </div>
        );
      }

      // ---------- Main App ----------
      function App() {
        const [students, setStudents] = useState([]);
        const [rows, setRows] = useState(5);
        const [cols, setCols] = useState(6);
        const [blocked, setBlocked] = useState(new Set());
        const [fixedMap, setFixedMap] = useState({});
        const [history, setHistory] = useState([]);
        const [current, setCurrent] = useState(null);
        const [options, setOptions] = useState(DEFAULT_OPTIONS);

        // Load
        useEffect(() => {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const data = JSON.parse(raw);
            if (data.students) setStudents(data.students.map(normalizeStudent));
            if (data.rows) setRows(data.rows);
            if (data.cols) setCols(data.cols);
            if (data.blocked) setBlocked(new Set(data.blocked));
            if (data.fixedMap) setFixedMap(data.fixedMap);
            if (data.history) setHistory(data.history);
          }
        }, []);

        // Save
        useEffect(() => {
          const data = { students, rows, cols, blocked: Array.from(blocked), fixedMap, history, current, options };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }, [students, rows, cols, blocked, fixedMap, history, current, options]);

        // ★スマホ対策の肝：サイズ変更時のクリーンアップにガードをかける
        useEffect(() => {
          // rows または cols が 0 や空文字のときはクリーンアップをスキップ（入力中とみなす）
          if (!rows || !cols || rows < 1 || cols < 1) return;

          setBlocked(prev => pruneBlockedForSize(prev, rows, cols));
          setFixedMap(prev => pruneFixedMapForSize(prev, rows, cols));
          
          if (current && (current.rows !== rows || current.cols !== cols)) {
            setCurrent(null); 
          }
        }, [rows, cols]);

        const toggleBlocked = (r, c) => {
          const sk = seatKey(r, c);
          setBlocked(prev => {
            const next = new Set(prev);
            if (next.has(sk)) next.delete(sk);
            else next.add(sk);
            return next;
          });
        };

        return (
          <div className="max-w-4xl mx-auto p-4 pb-20">
            <header className="mb-6">
              <h1 className="text-2xl font-bold text-gray-900">席替えアプリ</h1>
              <p className="text-sm text-gray-500">スマホ・PC両対応版</p>
            </header>

            <Section title="1. 座席サイズの設定">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs text-gray-500 mb-1">縦の列数 (行)</label>
                  <Input type="number" value={rows} onChange={setRows} min="1" />
                </div>
                <div>
                  <label className="block text-xs text-gray-500 mb-1">横の席数 (列)</label>
                  <Input type="number" value={cols} onChange={setCols} min="1" />
                </div>
              </div>
              <p className="text-[11px] text-amber-600 mt-2">※数字を消しても設定は保持されます。新しい数字を入力してください。</p>
            </Section>

            <Section title="2. 座席レイアウト">
              <p className="text-xs text-gray-500 mb-3">席をタップして「使用しない席(黒)」を切り替えます。</p>
              <div 
                className="grid gap-2 mx-auto" 
                style={{ 
                  gridTemplateColumns: `repeat(${cols || 1}, minmax(0, 1fr))`,
                  maxWidth: '100%' 
                }}
              >
                {Array.from({ length: rows || 0 }).map((_, r) =>
                  Array.from({ length: cols || 0 }).map((_, c) => {
                    const sk = seatKey(r, c);
                    const isBlocked = blocked.has(sk);
                    return (
                      <div
                        key={sk}
                        onClick={() => toggleBlocked(r, c)}
                        className={`aspect-square border-2 rounded-lg flex items-center justify-center cursor-pointer transition-colors ${
                          isBlocked ? 'bg-gray-800 border-gray-800 text-white' : 'bg-white border-gray-200 hover:border-blue-400'
                        }`}
                      >
                        <span className="text-[10px] opacity-30">{r}-{c}</span>
                      </div>
                    );
                  })
                )}
              </div>
            </Section>

            <div className="fixed bottom-4 left-4 right-4 max-w-4xl mx-auto">
               <Button onClick={() => alert("名簿機能などは元のロジックを統合してください")} variant="primary">
                 設定完了
               </Button>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
